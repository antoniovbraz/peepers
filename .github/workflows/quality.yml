name: ğŸ¨ Code Quality

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  lint:
    runs-on: ubuntu-latest

    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ğŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'

    - name: ğŸ“¦ Install dependencies
      run: npm ci

    - name: ğŸ¨ Run ESLint
      run: npm run lint

    - name: ğŸ” Check TypeScript types
      run: npx tsc --noEmit

    - name: ğŸ“ Check code formatting
      run: |
        if command -v prettier &> /dev/null; then
          npx prettier --check "src/**/*.{js,jsx,ts,tsx,json,css,md}"
        else
          echo "Prettier not configured, skipping format check"
        fi

  security:
    runs-on: ubuntu-latest

    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ğŸ”’ Run security audit
      run: npm audit --audit-level high

    - name: ğŸ›¡ï¸ Check for vulnerabilities
      run: |
        if [ -f ".env.example" ]; then
          echo "âœ… Environment template found"
        else
          echo "âš ï¸  .env.example not found"
        fi

        # Check for sensitive files
        if [ -f ".env" ] || [ -f ".env.local" ] || [ -f ".env.production" ]; then
          echo "âš ï¸  Sensitive environment files found in repository"
          echo "   Make sure these are in .gitignore"
        fi

  bundle-analysis:
    runs-on: ubuntu-latest

    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

      with:
        fetch-depth: 0

    - name: ğŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'

    - name: ğŸ“¦ Install dependencies
      run: npm ci

    - name: ğŸ“Š Analyze bundle size
      run: |
        npm run build

        # Check bundle size
        if [ -d ".next/static" ]; then
          bundle_size=$(du -sh .next/static | cut -f1)
          echo "ğŸ“¦ Bundle size: $bundle_size"

          # Warn if bundle is too large
          if [[ "$bundle_size" =~ "50M" ]] || [[ "$bundle_size" =~ "100M" ]] || [[ "$bundle_size" =~ "200M" ]]; then
            echo "âš ï¸  Bundle size is large: $bundle_size"
          fi
        fi

    - name: ğŸ“ˆ Compare bundle size
      if: github.event_name == 'pull_request'
      run: |
        echo "ğŸ“Š Bundle size comparison for PR"
        # This would compare with base branch if we had historical data