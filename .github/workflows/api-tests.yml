name: ğŸ§ª API Tests

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  schedule:
    # Run daily at 6 AM UTC
    - cron: '0 6 * * *'

jobs:
  api-tests:
    runs-on: ubuntu-latest

    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ğŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'

    - name: ğŸ“¦ Install dependencies
      run: npm ci

    - name: ğŸ—ï¸ Build application
      run: npm run build

    - name: ğŸš€ Start application
      run: |
        npm start &
        sleep 10

    - name: ğŸ§ª Test Health Endpoint
      run: |
        curl -f http://localhost:3000/api/health || exit 1
        echo "âœ… Health check passed"

    - name: ğŸ§ª Test Products Public API
      run: |
        response=$(curl -s http://localhost:3000/api/products-public?limit=5)
        if echo "$response" | jq -e '.success == true' > /dev/null; then
          echo "âœ… Products API test passed"
        else
          echo "âŒ Products API test failed"
          echo "Response: $response"
          exit 1
        fi

    - name: ğŸ§ª Test Admin Dashboard Metrics
      run: |
        response=$(curl -s -H "Cookie: user_id=123456789" http://localhost:3000/api/admin/dashboard/metrics)
        if echo "$response" | jq -e '.success == true' > /dev/null; then
          echo "âœ… Dashboard metrics test passed"
        else
          echo "âŒ Dashboard metrics test failed"
          echo "Response: $response"
          exit 1
        fi

    - name: ğŸ§ª Test Cache Debug
      run: |
        response=$(curl -s http://localhost:3000/api/cache-debug)
        if echo "$response" | jq -e '.success == true' > /dev/null; then
          echo "âœ… Cache debug test passed"
        else
          echo "âŒ Cache debug test failed"
          echo "Response: $response"
          exit 1
        fi

  security-tests:
    runs-on: ubuntu-latest

    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ğŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'

    - name: ğŸ“¦ Install dependencies
      run: npm ci

    - name: ğŸ”’ Security Audit
      run: npm audit --audit-level moderate

    - name: ğŸ§ª Run Security Tests
      run: |
        if [ -f "test-webhook-security.js" ]; then
          node test-webhook-security.js
        fi

    - name: ğŸ” Check for Security Issues
      run: |
        # Check for hardcoded secrets
        if grep -r "password\|secret\|token" --include="*.js" --include="*.ts" --include="*.json" src/ | grep -v "test\|mock\|example"; then
          echo "âš ï¸  Potential hardcoded secrets found"
          exit 1
        fi

        # Check for console.log in production code
        if grep -r "console\." --include="*.js" --include="*.ts" src/ | grep -v "test\|debug"; then
          echo "âš ï¸  Console statements found in production code"
          # Don't fail for now, just warn
        fi