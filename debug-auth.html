<!DOCTYPE html>
<html>
<head>
    <title>Teste de AutenticaÃ§Ã£o Peepers</title>
</head>
<body>
    <h1>ğŸ” Teste de AutenticaÃ§Ã£o Peepers</h1>
    
    <div id="status">Aguardando testes...</div>
    
    <br><br>
    
    <button onclick="testAuth()">1. Testar AutenticaÃ§Ã£o</button>
    <button onclick="testProducts()">2. Testar Produtos</button>
    <button onclick="goToAuth()">3. Fazer Login ML</button>
    <button onclick="clearServiceWorker()">4. Limpar SW</button>
    
    <br><br>
    
    <pre id="results"></pre>

    <script>
        const log = (msg) => {
            const results = document.getElementById('results');
            results.textContent += new Date().toLocaleTimeString() + ': ' + msg + '\n';
            console.log(msg);
        };

        const updateStatus = (msg) => {
            document.getElementById('status').textContent = msg;
        };

        async function testAuth() {
            try {
                updateStatus('ğŸ”„ Testando autenticaÃ§Ã£o...');
                const response = await fetch('https://peepers.vercel.app/api/auth/me', {
                    method: 'GET',
                    credentials: 'include',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    updateStatus('âœ… Autenticado!');
                    log('âœ… AutenticaÃ§Ã£o OK: ' + JSON.stringify(data, null, 2));
                } else {
                    updateStatus('âŒ NÃ£o autenticado');
                    log('âŒ Auth failed (' + response.status + '): ' + JSON.stringify(data, null, 2));
                }
            } catch (error) {
                updateStatus('ğŸ’¥ Erro de rede');
                log('ğŸ’¥ Erro na autenticaÃ§Ã£o: ' + error.message);
            }
        }

        async function testProducts() {
            try {
                updateStatus('ğŸ”„ Testando produtos...');
                const response = await fetch('https://peepers.vercel.app/api/products?format=summary&limit=5', {
                    method: 'GET',
                    credentials: 'include',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                const data = await response.json();
                
                if (response.ok && data.success) {
                    updateStatus('âœ… Produtos carregados!');
                    log('âœ… Produtos OK (' + data.data.items.length + ' items): ' + JSON.stringify(data.data.items.slice(0, 2), null, 2));
                } else {
                    updateStatus('âŒ Falha nos produtos');
                    log('âŒ Products failed (' + response.status + '): ' + JSON.stringify(data, null, 2));
                }
            } catch (error) {
                updateStatus('ğŸ’¥ Erro de rede');
                log('ğŸ’¥ Erro nos produtos: ' + error.message);
            }
        }

        function goToAuth() {
            window.open('https://peepers.vercel.app/api/auth/mercado-livre', '_blank');
        }

        async function clearServiceWorker() {
            try {
                if ('serviceWorker' in navigator) {
                    const registrations = await navigator.serviceWorker.getRegistrations();
                    for (let registration of registrations) {
                        await registration.unregister();
                        log('ğŸ§¹ Service Worker removido');
                    }
                    updateStatus('ğŸ§¹ Service Workers limpos');
                }
            } catch (error) {
                log('âŒ Erro ao limpar SW: ' + error.message);
            }
        }

        // Auto-test ao carregar
        window.onload = () => {
            log('ğŸš€ PÃ¡gina carregada, testando autenticaÃ§Ã£o...');
            testAuth();
        };
    </script>
</body>
</html>